document.addEventListener('DOMContentLoaded', () => {
    const articlesContainer = document.getElementById('articles-container');
    const refreshButton = document.querySelector('.refresh-button');

    // دالة مساعدة لتنسيق التاريخ
    const formatArticleDate = (dateString) => {
        try {
            const publishedDate = new Date(dateString);
            if (isNaN(publishedDate.getTime())) {
                throw new Error("تاريخ غير صالح");
            }
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return publishedDate.toLocaleDateString('ar-EG', options);
        } catch (e) {
            console.warn(`تحذير: لا يمكن تنسيق التاريخ "${dateString}". الخطأ: ${e.message}`);
            return 'تاريخ غير متوفر';
        }
    };

    // دالة لإنشاء بطاقة المقال
    const createArticleCard = (article) => {
        const articleCard = document.createElement('div');
        articleCard.classList.add('article-card');

        const formattedDate = formatArticleDate(article.published);

        articleCard.innerHTML = `
            <h2><a href="${article.link}" target="_blank" rel="noopener noreferrer">${article.title}</a></h2>
            <p>${article.summary}</p>
            <div class="meta">
                <span class="source">المصدر: ${article.source}</span>
                <span class="date">${formattedDate}</span>
            </div>
            <a href="${article.link}" target="_blank" rel="noopener noreferrer">قراءة المزيد &raquo;</a>
        `;
        return articleCard;
    };

    // دالة لجلب وعرض المقالات
    const fetchAndDisplayArticles = async () => {
        articlesContainer.innerHTML = '<p class="loading">جاري تحميل الأخبار... يرجى الانتظار.</p>'; // عرض رسالة التحميل

        try {
            const response = await fetch('articles.json?' + new Date().getTime()); // إضافة timestamp لتجنب التخزين المؤقت
            if (!response.ok) {
                throw new Error(`فشل تحميل ملف الأخبار: ${response.status} ${response.statusText}. تأكد من أن ملف articles.json موجود ويمكن الوصول إليه.`);
            }
            const articles = await response.json();

            articlesContainer.innerHTML = ''; // مسح رسالة التحميل

            if (articles.length === 0) {
                articlesContainer.innerHTML = '<p style="text-align: center; color: #6c757d;">لا توجد مقالات لعرضها حاليًا.</p>';
                return;
            }

            articles.forEach(article => {
                articlesContainer.appendChild(createArticleCard(article));
            });

        } catch (error) {
            console.error('حدث خطأ أثناء جلب الأخبار:', error);
            articlesContainer.innerHTML = `<p style="color: red; text-align: center;">عذرًا، حدث خطأ أثناء تحميل الأخبار: ${error.message}<br>يرجى التأكد من تشغيل ملف run_news.bat وأن ملف articles.json موجود.</p>`;
        }
    };

    // جلب الأخبار عند تحميل الصفحة لأول مرة
    fetchAndDisplayArticles();

    // إضافة مستمع حدث لزر التحديث بدلاً من onclick المباشر في HTML
    if (refreshButton) {
        refreshButton.addEventListener('click', fetchAndDisplayArticles);
    }

    // يمكنك إضافة تحديث تلقائي هنا إذا أردت، مثلاً كل 5 دقائق
    // setInterval(fetchAndDisplayArticles, 300000); // 300000 مللي ثانية = 5 دقائق
});
